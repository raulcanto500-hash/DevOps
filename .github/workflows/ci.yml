name: CI (tests backend)

on:
  push:
    branches:
      - "**"

jobs:
  test-backend:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: todo-java

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Instalar dependencias (librerÃ­as)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/download-libs.sh
          bash scripts/download-libs.sh
          ls -la lib

      - name: Compilar MAIN
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/main
          find src/main/java -name "*.java" > sources.txt
          javac -cp "lib/*" -d out/main @sources.txt

      - name: Compilar TESTS
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out/test
          find src/test/java -name "*.java" > test-sources.txt
          javac -cp "lib/*:out/main" -d out/test @test-sources.txt

      - name: Ejecutar TESTS (JUnit Console)
        shell: bash
        run: |
          set -euo pipefail
          java -jar lib/junit-platform-console-standalone-1.10.3.jar \
            -cp "lib/*:out/main:out/test" \
            --scan-classpath
